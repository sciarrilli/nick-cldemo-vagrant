
Vagrant.configure("2") do |config|
  wbid = 1
  config.vm.provider "virtualbox" do |v|
    v.gui=false
  end


{% for device in devices %}
{% if device.category == 'oob-mgmt-server' %}
  config.vm.define "{{ device.hostname }}" do |device|
      device.vm.provider "virtualbox" do |v|
        v.name = "{{ device.hostname }}"
        v.memory = {{ device.memory }}
      end
      device.vm.hostname = "{{ device.hostname }}"
      device.vm.box = "boxcutter/ubuntu1404"

    {% for cable in device.eth_map %}
    device.vm.network "private_network", virtualbox__intnet: "net_#{wbid}_{{ device.cabling[cable].net_id }}", auto_config: false {% if cable in device.mac_map %}, :mac => "{{ device.mac_map[cable]|replace(':', '') }}"{% endif %}
    {% endfor %}

      device.vm.synced_folder ".", "/vagrant", disabled: true
      device.vm.provision :shell , inline: "sudo sed -i 's/sleep [0-9]*/sleep 1/' /etc/init/failsafe.conf"
      device.vm.provision :shell , path: "./helper_scripts/oob_server_config.sh"
      device.vm.provision "file", source: "./helper_scripts/rename_eth_swp", destination: "/home/vagrant/rename_eth_swp"
      device.vm.provision "file", source: "./helper_scripts/autogenerated/{{ device.hostname }}_remap_eth", destination: "/home/vagrant/remap_eth"
      device.vm.provision :shell , inline: "mv /home/vagrant/rename_eth_swp /etc/init.d/rename_eth_swp"
      device.vm.provision :shell , inline: "mv /home/vagrant/remap_eth /etc/default/remap_eth"
      device.vm.provision :shell , inline: "chmod 755 /etc/init.d/rename_eth_swp"
      device.vm.provision :shell , inline: "sudo sed -i '/exit 0/d' /etc/rc.local "
      device.vm.provision :shell , inline: "sudo echo '/etc/init.d/rename_eth_swp start' >> /etc/rc.local "
      device.vm.provision :shell , inline: "sudo echo 'exit 0' >> /etc/rc.local "
      device.vm.provision :shell , inline: "/etc/init.d/rename_eth_swp verbose"

      device.vm.provider "virtualbox" do |vbox|
        {% for i in range(2, 2+device.eth_map.__len__()) %}
        vbox.customize ['modifyvm', :id, '--nicpromisc{{i}}', 'allow-vms']
        {% endfor %}
        {% for i in range(1, 2+device.eth_map.__len__()) %}
        vbox.customize ["modifyvm", :id, "--nictype{{i}}", "virtio"]
        {% endfor %}
      end

      device.vm.provision "ansible" do |ansible|
        ansible.playbook = "./playbook/site.yml"
        ansible.extra_vars = {wbench_hosts: {
            {% for device2 in devices %}
            {% if "eth0" in device2.mac_map %}
                {{ device2.hostname}}: {ip: "{{device2.mgmt_ip}}", mac: "{{device2.mac_map['eth0']}}"},
            {% endif %}
            {% endfor %}
                            }}
      end
  end
{% elif device.category == 'oob-mgmt-switch' %}
config.vm.define "{{ device.hostname }}" do |device|
    device.vm.provider "virtualbox" do |v|
      v.name = "{{ device.hostname }}"
      v.memory = {{ device.memory }}
    end
    device.vm.hostname = "{{ device.hostname }}"
    device.vm.box = "CumulusCommunity/cumulus-vx"

        {% for cable in device.eth_map %}
        device.vm.network "private_network", virtualbox__intnet: "net_#{wbid}_{{ device.cabling[cable].net_id }}", auto_config: false {% if cable in device.mac_map %}, :mac => "{{ device.mac_map[cable]|replace(':', '') }}"{% endif %}
        {% endfor %}

    # Disabling the default synced folder
    device.vm.synced_folder ".", "/vagrant", disabled: true
    device.vm.provision :shell , path: "./helper_scripts/oob_switch_config.sh"
    device.vm.provision "file", source: "./helper_scripts/rename_eth_swp", destination: "/home/vagrant/rename_eth_swp"
    device.vm.provision "file", source: "./helper_scripts/autogenerated/{{ device.hostname }}_remap_eth", destination: "/home/vagrant/remap_eth"
    device.vm.provision :shell , inline: "mv /home/vagrant/rename_eth_swp /etc/init.d/rename_eth_swp"
    device.vm.provision :shell , inline: "mv /home/vagrant/remap_eth /etc/default/remap_eth"
    device.vm.provision :shell , inline: "chmod 755 /etc/init.d/rename_eth_swp"
    device.vm.provision :shell , inline: "/etc/init.d/rename_eth_swp verbose"

    device.vm.provider "virtualbox" do |vbox|
        {% for i in range(2, 2+device.eth_map.__len__()) %}
        vbox.customize ['modifyvm', :id, '--nicpromisc{{i}}', 'allow-vms']
        {% endfor %}
    end
end
{% elif device.category == 'internet' %}

config.vm.define "{{ device.hostname }}" do |device|
    device.vm.provider "virtualbox" do |v|
      v.name = "{{ device.hostname }}"
      v.memory = {{ device.memory }}
    end
    device.vm.hostname = "{{ device.hostname }}"
    device.vm.box = "CumulusCommunity/cumulus-vx"

        {% for cable in device.eth_map %}
        device.vm.network "private_network", virtualbox__intnet: "net_#{wbid}_{{ device.cabling[cable].net_id }}", auto_config: false {% if cable in device.mac_map %}, :mac => "{{ device.mac_map[cable]|replace(':', '') }}"{% endif %}
        {% endfor %}

    device.vm.synced_folder ".", "/vagrant", disabled: true
    device.vm.provision :shell , path: "./helper_scripts/internet_config.sh"
    device.vm.provision "file", source: "./helper_scripts/rename_eth_swp", destination: "/home/vagrant/rename_eth_swp"
    device.vm.provision "file", source: "./helper_scripts/autogenerated/{{ device.hostname }}_remap_eth", destination: "/home/vagrant/remap_eth"
    device.vm.provision :shell , inline: "mv /home/vagrant/rename_eth_swp /etc/init.d/rename_eth_swp"
    device.vm.provision :shell , inline: "mv /home/vagrant/remap_eth /etc/default/remap_eth"
    device.vm.provision :shell , inline: "chmod 755 /etc/init.d/rename_eth_swp"
    device.vm.provision :shell , inline: "/etc/init.d/rename_eth_swp verbose"

    device.vm.provider "virtualbox" do |vbox|
        {% for i in range(2, 2+device.eth_map.__len__()) %}
        vbox.customize ['modifyvm', :id, '--nicpromisc{{i}}', 'allow-vms']
        {% endfor %}
    end
end

{% elif device.category == 'switch' %}
config.vm.define "{{ device.hostname }}" do |device|
    device.vm.provider "virtualbox" do |v|
      v.name = "{{ device.hostname }}"
      v.memory = {{ device.memory }}
    end
    device.vm.hostname = "{{ device.hostname }}"
    device.vm.box = "CumulusCommunity/cumulus-vx"

        {% for cable in device.eth_map %}
        device.vm.network "private_network", virtualbox__intnet: "net_#{wbid}_{{ device.cabling[cable].net_id }}", auto_config: false {% if cable in device.mac_map %}, :mac => "{{ device.mac_map[cable]|replace(':', '') }}"{% endif %}
        {% endfor %}

    # Disabling the default synced folder
    device.vm.synced_folder ".", "/vagrant", disabled: true
    device.vm.provision :shell , path: "./helper_scripts/pre_config.sh"
    device.vm.provision "file", source: "./helper_scripts/rename_eth_swp", destination: "/home/vagrant/rename_eth_swp"
    device.vm.provision "file", source: "./helper_scripts/autogenerated/{{ device.hostname }}_remap_eth", destination: "/home/vagrant/remap_eth"
    device.vm.provision :shell , inline: "mv /home/vagrant/rename_eth_swp /etc/init.d/rename_eth_swp"
    device.vm.provision :shell , inline: "mv /home/vagrant/remap_eth /etc/default/remap_eth"
    device.vm.provision :shell , inline: "chmod 755 /etc/init.d/rename_eth_swp"
    device.vm.provision :shell , inline: "/etc/init.d/rename_eth_swp verbose"

    device.vm.provider "virtualbox" do |vbox|
        {% for i in range(2, 2+device.eth_map.__len__()) %}
        vbox.customize ['modifyvm', :id, '--nicpromisc{{i}}', 'allow-vms']
        {% endfor %}
    end

    device.vm.provision :shell , path: "./helper_scripts/post_config_switch.sh"
end

{% elif device.category == 'server' %}
config.vm.define "{{ device.hostname }}" do |device|
    device.vm.provider "virtualbox" do |v|
      v.name = "{{ device.hostname }}"
      v.memory = {{ device.memory }}
    end
    device.vm.hostname = "{{ device.hostname }}"
    device.vm.box = "boxcutter/ubuntu1404"

        {% for cable in device.eth_map %}
        device.vm.network "private_network", virtualbox__intnet: "net_#{wbid}_{{ device.cabling[cable].net_id }}", auto_config: false {% if cable in device.mac_map %}, :mac => "{{ device.mac_map[cable]|replace(':', '') }}"{% endif %}
        {% endfor %}

    device.vm.synced_folder ".", "/vagrant", disabled: true
    device.vm.provision :shell , inline: "sudo sed -i 's/sleep [0-9]*/sleep 1/' /etc/init/failsafe.conf"
    device.vm.provision :shell , path: "./helper_scripts/pre_config.sh"
    device.vm.provision "file", source: "./helper_scripts/rename_eth_swp", destination: "/home/vagrant/rename_eth_swp"
    device.vm.provision "file", source: "./helper_scripts/autogenerated/{{ device.hostname }}_remap_eth", destination: "/home/vagrant/remap_eth"
    device.vm.provision :shell , inline: "mv /home/vagrant/rename_eth_swp /etc/init.d/rename_eth_swp"
    device.vm.provision :shell , inline: "mv /home/vagrant/remap_eth /etc/default/remap_eth"
    device.vm.provision :shell , inline: "chmod 755 /etc/init.d/rename_eth_swp"
    device.vm.provision :shell , inline: "sudo sed -i '/exit 0/d' /etc/rc.local "
    device.vm.provision :shell , inline: "sudo echo '/etc/init.d/rename_eth_swp start' >> /etc/rc.local "
    device.vm.provision :shell , inline: "sudo echo 'exit 0' >> /etc/rc.local "
    device.vm.provision :shell , inline: "/etc/init.d/rename_eth_swp verbose"

    device.vm.provider "virtualbox" do |vbox|
        {% for i in range(2, 2+device.eth_map.__len__()) %}
        vbox.customize ['modifyvm', :id, '--nicpromisc{{i}}', 'allow-vms']
        {% endfor %}
    end

    device.vm.provision :shell , path: "./helper_scripts/post_config_server.sh"
end
{% endif %}
{% endfor %}


end
